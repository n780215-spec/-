<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤©éº—å‘¨å¹´æ…¶è³¼è²·æ¸…å–®</title>

  <!-- PWA è¨­å®š -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å¤©éº—æ¸…å–®">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #4CAF50; }
    .product { margin-bottom: 10px; }
    .btn-level { margin: 3px; padding: 8px 12px; border: none; border-radius: 6px; background: #4CAF50; color: white; }
    select { padding: 5px; }
    #result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>å¤©éº—å‘¨å¹´æ…¶è³¼è²·æ¸…å–®</h1>

  <!-- æœƒå“¡ç­‰ç´šé¸æ“‡ -->
  <h3>æœƒå“¡ç­‰ç´š</h3>
  <div id="member-levels">
    <button class="btn-level" onclick="setLevel('æœƒå“¡', 0)">æœƒå“¡</button>
    <button class="btn-level" onclick="setLevel('å°ˆå“¡', 25)">å°ˆå“¡</button>
    <button class="btn-level" onclick="setLevel('ä¸»ä»»', 30)">ä¸»ä»»</button>
    <button class="btn-level" onclick="setLevel('ç¶“ç†', 35)">ç¶“ç†</button>
    <button class="btn-level" onclick="setLevel('å¯¶çŸ³', 37)">å¯¶çŸ³</button>
    <button class="btn-level" onclick="setLevel('é‘½çŸ³', 38)">é‘½çŸ³</button>
    <button class="btn-level" onclick="setLevel('é‡‘é‘½', 39)">é‡‘é‘½</button>
    <button class="btn-level" onclick="setLevel('é¡§å•', 40)">é¡§å•</button>
  </div>

  <h3>å•†å“åˆ—è¡¨</h3>
  <div id="products"></div>

  <button onclick="generateSummary()">ç”Ÿæˆè³¼è²·æ¸…å–®</button>
  <div id="result"></div>
  <button id="pdfBtn" style="display:none;" onclick="generatePDF()">ä¸‹è¼‰ PDF</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // å•†å“è³‡æ–™
    const productList = [
      { code: "P001", name: "ç´…åƒç²¾è¯é£²", price: 1200, pv: 100 },
      { code: "P002", name: "è† åŸè›‹ç™½ç²‰", price: 1500, pv: 120 },
      { code: "P003", name: "ç¶œåˆç¶­ä»–å‘½", price: 800, pv: 60 }
    ];

    let memberLevel = { name: "æœƒå“¡", rate: 0 };

    function setLevel(name, rate) {
      memberLevel = { name, rate };
      alert("å·²é¸æ“‡æœƒå“¡ç­‰ç´šï¼š" + name);
    }

    function renderProducts() {
      const container = document.getElementById("products");
      container.innerHTML = "";
      productList.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <b>${p.code}</b> ${p.name} - $${p.price} / ${p.pv}PV
          <select id="qty-${p.code}">
            ${Array.from({length: 21}, (_, i) => `<option value="${i}">${i}</option>`).join("")}
          </select>
        `;
        container.appendChild(div);
      });
    }

    function generateSummary() {
      let totalAmount = 0, totalPV = 0;
      let summary = "<h3>è³¼è²·æ¸…å–®</h3><ul>";

      productList.forEach(p => {
        const qty = parseInt(document.getElementById("qty-" + p.code).value);
        if (qty > 0) {
          const subtotal = p.price * qty;
          const subPV = p.pv * qty;
          totalAmount += subtotal;
          totalPV += subPV;
          summary += `<li>${p.name} x ${qty} = $${subtotal} / ${subPV}PV</li>`;

          // è²·8é€1
          if (qty >= 8) {
            const freeQty = Math.floor(qty / 8);
            summary += `<li>ğŸ è´ˆé€ ${p.name} x ${freeQty}</li>`;
          }
        }
      });

      summary += "</ul>";
      summary += `<p>å•†å“ç¸½é¡ï¼š$${totalAmount}</p>`;
      summary += `<p>PV ç¸½æ•¸ï¼š${totalPV}</p>`;

      const bonus = Math.floor(totalPV * memberLevel.rate / 100);
      summary += `<p>æœƒå“¡ç­‰ç´šï¼š${memberLevel.name} (${memberLevel.rate}%)</p>`;
      summary += `<p>æ¥­ç¸¾çé‡‘ï¼š${bonus}</p>`;

      document.getElementById("result").innerHTML = summary;
      document.getElementById("pdfBtn").style.display = "block";
    }

    function generatePDF() {
      const element = document.getElementById("result");
      html2pdf().from(element).set({
        margin: 10,
        filename: "å¤©éº—è³¼è²·æ¸…å–®.pdf",
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      }).save();
    }

    renderProducts();
  </script>

  <!-- è¨»å†Š Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("âœ… Service Worker è¨»å†ŠæˆåŠŸ"))
        .catch(err => console.log("âŒ Service Worker å¤±æ•—", err));
    }
  </script>
</body>
</html>
